<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>MEGAM ARG Detection - Bases de Donn√©es</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .updating { animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes progress-stripes {
      0% { background-position: 1rem 0; }
      100% { background-position: 0 0; }
    }
    .progress-indeterminate {
      background-image: linear-gradient(
        45deg, rgba(255,255,255,0.15) 25%, transparent 25%,
        transparent 50%, rgba(255,255,255,0.15) 50%,
        rgba(255,255,255,0.15) 75%, transparent 75%, transparent
      );
      background-size: 1rem 1rem;
      animation: progress-stripes 0.5s linear infinite;
    }
  </style>
</head>
<body class="min-h-screen bg-gray-100">

  <!-- HEADER -->
  <header class="bg-blue-900 text-white px-6 py-3 shadow-lg">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="logo.png" alt="MEGAM ARG Detection" class="h-12 w-auto">
      </div>
      <nav class="flex gap-1 items-center">
        <a id="running-jobs-indicator" href="#" class="hidden bg-orange-500 text-white px-3 py-2 rounded font-medium hover:bg-orange-600 transition items-center gap-2 animate-pulse">
          <span class="animate-spin">‚öôÔ∏è</span> <span id="running-count">0</span> en cours
        </a>
        <a href="form_launch_analysis.html" class="bg-blue-700 text-white px-4 py-2 rounded font-medium hover:bg-blue-600 transition text-sm">
          Nouvelle Analyse
        </a>
        <a href="jobs_list.html" class="bg-blue-700 text-white px-4 py-2 rounded font-medium hover:bg-blue-600 transition text-sm">
          Historique
        </a>
        <a href="databases.html" class="bg-white text-blue-900 px-4 py-2 rounded font-medium hover:bg-blue-100 transition text-sm">
          Bases de donn√©es
        </a>
        <a href="dashboard_monitoring.html" class="bg-blue-700 text-white px-4 py-2 rounded font-medium hover:bg-blue-600 transition text-sm">
          Dashboard
        </a>
        <button onclick="openAboutModal()" class="bg-blue-700 text-white px-4 py-2 rounded font-medium hover:bg-blue-600 transition text-sm">
          √Ä propos
        </button>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8">

    <!-- Titre -->
    <div class="mb-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">üóÑÔ∏è Bases de Donn√©es ARG</h2>
      <p class="text-gray-600">G√©rez les bases de donn√©es utilis√©es par le pipeline pour la d√©tection des g√®nes de r√©sistance.</p>
    </div>

    <!-- Stats globales -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow p-4 text-center">
        <p class="text-3xl font-bold text-blue-600" id="total-db">0</p>
        <p class="text-sm text-gray-500">Total</p>
      </div>
      <div class="bg-white rounded-lg shadow p-4 text-center">
        <p class="text-3xl font-bold text-green-600" id="ready-db">0</p>
        <p class="text-sm text-gray-500">Pr√™tes</p>
      </div>
      <div class="bg-white rounded-lg shadow p-4 text-center">
        <p class="text-3xl font-bold text-red-600" id="missing-db">0</p>
        <p class="text-sm text-gray-500">Manquantes</p>
      </div>
      <div class="bg-white rounded-lg shadow p-4 text-center">
        <p class="text-3xl font-bold text-gray-600" id="total-size">-</p>
        <p class="text-sm text-gray-500">Espace utilis√©</p>
      </div>
    </section>

    <!-- Boutons globaux -->
    <section class="bg-white rounded-lg shadow p-4 mb-6 flex flex-wrap gap-4 items-center justify-between">
      <div class="flex gap-2">
        <button onclick="loadDatabases()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded font-semibold hover:bg-gray-200 flex items-center gap-2">
          üîÑ Rafra√Æchir
        </button>
        <button onclick="updateAllMissing()" class="bg-green-600 text-white px-4 py-2 rounded font-semibold hover:bg-green-700 flex items-center gap-2">
          üì• T√©l√©charger manquantes
        </button>
      </div>
      <p class="text-sm text-gray-500">
        Dossier: <code id="db-path" class="bg-gray-100 px-2 py-1 rounded">-</code>
      </p>
    </section>

    <!-- Liste des bases de donn√©es -->
    <section id="databases-list" class="space-y-4">
      <div class="text-center py-8 text-gray-500">
        <div class="animate-spin text-4xl mb-4">üîÑ</div>
        Chargement...
      </div>
    </section>

    <!-- Log des op√©rations -->
    <section class="mt-8 bg-white rounded-lg shadow overflow-hidden">
      <div class="bg-gray-50 px-4 py-3 border-b flex items-center justify-between">
        <h3 class="font-bold text-gray-800">üìã Log des op√©rations</h3>
        <button onclick="clearLogs()" class="text-sm text-gray-500 hover:text-gray-700">Effacer</button>
      </div>
      <div id="logs-container" class="h-48 overflow-y-auto bg-gray-900 text-green-400 p-4 font-mono text-xs">
        <p class="text-gray-500">En attente...</p>
      </div>
    </section>

  </main>

  <!-- About Modal -->
  <div id="about-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-8 max-w-md mx-4">
      <div class="text-center">
        <img src="logo.png" alt="MEGAM ARG Detection" class="h-20 mx-auto mb-4">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">MEGAM ARG Detection WEB</h2>
        <p class="text-gray-600 mb-6">Pipeline de D√©tection des G√®nes de R√©sistance aux Antimicrobiens</p>

        <div class="bg-blue-50 rounded-lg p-4 mb-6">
          <p class="text-sm text-gray-600 mb-2">D√©velopp√© par</p>
          <p class="text-lg font-bold text-blue-900">Rachid Merah</p>
          <a href="mailto:rachid.merah77@gmail.com" class="text-blue-600 hover:underline block">rachid.merah77@gmail.com</a>
          <a href="https://wa.me/213556146653" target="_blank" class="text-green-600 hover:underline flex items-center justify-center gap-1 mt-2">
            <span>üì±</span> +213 556 146 653 (WhatsApp)
          </a>
        </div>

        <p class="text-sm text-gray-600 mb-4 px-4">
          Contactez-moi pour signaler un bug ou proposer des am√©liorations.
        </p>

        <a href="https://github.com/rmerah/MEGAM-ARG-detection" target="_blank" class="inline-flex items-center gap-2 text-gray-700 hover:text-black font-semibold mb-4">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
          GitHub
        </a>

        <p class="text-sm text-gray-500 mb-6">Version 3.2</p>

        <button onclick="closeAboutModal()" class="bg-blue-600 text-white px-6 py-2 rounded font-semibold hover:bg-blue-700 transition">
          Fermer
        </button>
      </div>
    </div>
  </div>

  <script src="api-client.js"></script>
  <script>
    let logs = [];
    let updatingDbs = new Set();
    let pollingIntervals = {};  // {dbKey: intervalId}
    let progressData = {};      // {dbKey: {progress, message, ...}}

    async function loadDatabases() {
      try {
        addLog('INFO', 'Chargement des bases de donn√©es...');

        const response = await fetch(`${API_BASE_URL}/api/databases`, {
          headers: { 'Cache-Control': 'no-cache' }
        });

        if (!response.ok) throw new Error('Erreur API');

        const data = await response.json();
        document.getElementById('db-path').textContent = data.databases_dir;

        renderDatabases(data.databases);
        updateStats(data.databases);

        addLog('SUCCESS', `${data.databases.length} bases de donn√©es charg√©es`);

      } catch (error) {
        console.error('Erreur:', error);
        addLog('ERROR', `Erreur: ${error.message}`);
        document.getElementById('databases-list').innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded-lg p-8 text-center">
            <p class="text-red-600 font-semibold">Erreur de connexion √† l'API</p>
            <p class="text-sm text-red-500 mt-2">V√©rifiez que le backend est lanc√© sur le port 8000</p>
          </div>
        `;
      }
    }

    function renderDatabases(databases) {
      const container = document.getElementById('databases-list');

      container.innerHTML = databases.map(db => {
        const safeKey = escapeHtml(db.key);
        const isUpdating = updatingDbs.has(db.key);
        const statusColor = db.ready ? 'bg-green-100 text-green-800 border-green-200' :
                           db.exists ? 'bg-yellow-100 text-yellow-800 border-yellow-200' :
                           'bg-red-100 text-red-800 border-red-200';
        const statusText = db.ready ? '‚úÖ Pr√™te' :
                          db.exists ? '‚ö†Ô∏è Incompl√®te' :
                          '‚ùå Manquante';

        // Valider db.key avant utilisation dans onclick
        if (!/^[a-z0-9_]+$/.test(db.key)) return '';

        return `
          <div class="bg-white rounded-lg shadow overflow-hidden ${isUpdating ? 'updating' : ''}">
            <div class="p-6">
              <div class="flex items-start justify-between">
                <div class="flex items-center gap-4">
                  <div class="text-4xl">${getDbIcon(db.key)}</div>
                  <div>
                    <h3 class="text-lg font-bold text-gray-800">${escapeHtml(db.name)}</h3>
                    <p class="text-sm text-gray-500">${escapeHtml(db.description)}</p>
                  </div>
                </div>
                <div class="text-right">
                  <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold border ${statusColor}">
                    ${statusText}
                  </span>
                </div>
              </div>

              <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                  <p class="text-gray-500">Taille actuelle</p>
                  <p class="font-semibold text-gray-800">${escapeHtml(db.size_human || '-')}</p>
                </div>
                <div>
                  <p class="text-gray-500">Taille estim√©e</p>
                  <p class="font-semibold text-gray-800">${escapeHtml(db.size_estimate)}</p>
                </div>
                <div>
                  <p class="text-gray-500">Derni√®re M√†J</p>
                  <p class="font-semibold text-gray-800">${db.last_updated ? new Date(db.last_updated).toLocaleDateString('fr-FR') : '-'}</p>
                </div>
                <div>
                  <p class="text-gray-500">Chemin</p>
                  <p class="font-mono text-xs text-gray-600 truncate" title="${escapeHtml(db.path)}">${escapeHtml(db.path.split('/').pop())}</p>
                </div>
              </div>

              <div class="mt-4 flex gap-2">
                ${!db.ready ? `
                  <button onclick="updateDatabase('${safeKey}')" ${isUpdating ? 'disabled' : ''}
                          class="bg-blue-600 text-white px-4 py-2 rounded font-semibold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                    ${isUpdating ? '<span class="animate-spin">‚è≥</span> En cours...' : 'üì• T√©l√©charger'}
                  </button>
                ` : `
                  <button onclick="updateDatabase('${safeKey}')" ${isUpdating ? 'disabled' : ''}
                          class="bg-gray-100 text-gray-700 px-4 py-2 rounded font-semibold hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                    ${isUpdating ? '<span class="animate-spin">‚è≥</span> En cours...' : 'üîÑ Mettre √† jour'}
                  </button>
                `}
              </div>

              <!-- Barre de progression -->
              <div id="progress-${safeKey}" class="mt-3 ${isUpdating ? '' : 'hidden'}">
                ${renderProgressBar(db.key)}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateStats(databases) {
      const total = databases.length;
      const ready = databases.filter(d => d.ready).length;
      const missing = databases.filter(d => !d.ready).length;
      const totalSize = databases.reduce((sum, d) => sum + (d.size_bytes || 0), 0);

      document.getElementById('total-db').textContent = total;
      document.getElementById('ready-db').textContent = ready;
      document.getElementById('missing-db').textContent = missing;
      document.getElementById('total-size').textContent = formatSize(totalSize);
    }

    function renderProgressBar(dbKey) {
      const data = progressData[dbKey];
      if (!data) return `
        <div class="flex justify-between text-xs text-gray-500 mb-1">
          <span>D√©marrage...</span>
          <span></span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div class="bg-blue-600 h-2.5 rounded-full progress-indeterminate" style="width: 100%"></div>
        </div>
      `;

      const isIndeterminate = data.progress < 0;
      const isFailed = data.status === 'failed';
      const isCompleted = data.status === 'completed';
      const barColor = isFailed ? 'bg-red-500' : isCompleted ? 'bg-green-500' : 'bg-blue-600';
      const barWidth = isIndeterminate ? 100 : Math.max(data.progress, 2);

      const sizeInfo = data.downloaded_bytes > 0
        ? `${formatSize(data.downloaded_bytes)}${data.total_bytes > 0 ? ' / ' + formatSize(data.total_bytes) : ''}`
        : '';

      return `
        <div class="flex justify-between text-xs text-gray-600 mb-1">
          <span class="font-medium">${escapeHtml(data.message || '')}</span>
          <span class="font-semibold">${isIndeterminate ? '' : data.progress + '%'}</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
          <div class="${barColor} h-2.5 rounded-full transition-all duration-700 ease-out ${isIndeterminate && !isFailed && !isCompleted ? 'progress-indeterminate' : ''}"
               style="width: ${barWidth}%"></div>
        </div>
        <div class="flex justify-between text-xs text-gray-400 mt-1">
          <span>${escapeHtml(sizeInfo)}</span>
          <span>${escapeHtml(data.speed || '')}</span>
        </div>
      `;
    }

    function updateProgressUI(dbKey) {
      const el = document.getElementById(`progress-${dbKey}`);
      if (el) {
        el.innerHTML = renderProgressBar(dbKey);
        el.classList.remove('hidden');
      }
    }

    function startPolling(dbKey) {
      if (pollingIntervals[dbKey]) return;

      pollingIntervals[dbKey] = setInterval(async () => {
        try {
          const response = await fetch(`${API_BASE_URL}/api/databases/${dbKey}/progress`);
          const data = await response.json();

          if (!data.active) {
            // T√©l√©chargement termin√© ou pas en cours
            stopPolling(dbKey);
            updatingDbs.delete(dbKey);
            delete progressData[dbKey];
            loadDatabases();
            return;
          }

          progressData[dbKey] = data;
          updateProgressUI(dbKey);

          if (data.status === 'completed') {
            addLog('SUCCESS', `‚úÖ ${dbKey} mis √† jour avec succ√®s`);
            stopPolling(dbKey);
            // Attendre un peu puis rafra√Æchir (le backend garde le statut 30s)
            setTimeout(() => {
              updatingDbs.delete(dbKey);
              delete progressData[dbKey];
              loadDatabases();
            }, 2000);
          } else if (data.status === 'failed') {
            addLog('ERROR', `‚ùå ${dbKey}: ${data.message || data.error || '√âchec'}`);
            stopPolling(dbKey);
            setTimeout(() => {
              updatingDbs.delete(dbKey);
              delete progressData[dbKey];
              loadDatabases();
            }, 3000);
          }
        } catch (error) {
          console.error(`Polling error for ${dbKey}:`, error);
        }
      }, 2000);
    }

    function stopPolling(dbKey) {
      if (pollingIntervals[dbKey]) {
        clearInterval(pollingIntervals[dbKey]);
        delete pollingIntervals[dbKey];
      }
    }

    async function updateDatabase(dbKey) {
      if (updatingDbs.has(dbKey)) return;

      updatingDbs.add(dbKey);
      progressData[dbKey] = null;
      loadDatabases(); // Re-render pour montrer le statut "En cours"

      addLog('INFO', `D√©but mise √† jour: ${dbKey}...`);

      try {
        const response = await fetch(`${API_BASE_URL}/api/databases/${dbKey}/update`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (response.ok && data.started) {
          addLog('INFO', `${data.message}`);
          startPolling(dbKey);
        } else if (response.status === 409) {
          addLog('WARN', `${dbKey}: t√©l√©chargement d√©j√† en cours`);
          startPolling(dbKey);
        } else {
          addLog('ERROR', `‚ùå Erreur: ${data.detail || 'Inconnue'}`);
          updatingDbs.delete(dbKey);
          loadDatabases();
        }

      } catch (error) {
        addLog('ERROR', `Erreur r√©seau: ${error.message}`);
        updatingDbs.delete(dbKey);
        loadDatabases();
      }
    }

    async function updateAllMissing() {
      const response = await fetch(`${API_BASE_URL}/api/databases`);
      const data = await response.json();

      const missing = data.databases.filter(d => !d.ready);

      if (missing.length === 0) {
        addLog('INFO', 'Toutes les bases de donn√©es sont d√©j√† pr√™tes');
        return;
      }

      addLog('INFO', `Lancement du t√©l√©chargement de ${missing.length} bases manquantes...`);

      // Lancer tous les t√©l√©chargements (le backend g√®re chacun dans un thread s√©par√©)
      for (const db of missing) {
        updateDatabase(db.key);
      }
    }

    // Reprendre le polling pour les t√©l√©chargements en cours (si on rafra√Æchit la page)
    async function resumeActiveDownloads() {
      for (const dbKey of Object.keys(DATABASES_CONFIG_KEYS)) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/databases/${dbKey}/progress`);
          const data = await response.json();
          if (data.active && data.status !== 'completed' && data.status !== 'failed') {
            updatingDbs.add(dbKey);
            progressData[dbKey] = data;
            startPolling(dbKey);
          }
        } catch (e) { /* ignore */ }
      }
      // Re-render si des downloads actifs trouv√©s
      if (updatingDbs.size > 0) loadDatabases();
    }

    const DATABASES_CONFIG_KEYS = {
      'kraken2': true, 'amrfinder': true, 'card': true,
      'pointfinder': true, 'mlst': true, 'kma': true
    };

    function getDbIcon(key) {
      const icons = {
        'kraken2': 'ü¶†',
        'amrfinder': 'üíä',
        'card': 'üÉè',
        'pointfinder': 'üéØ',
        'mlst': 'üß¨',
        'kma': 'üîë'
      };
      return icons[key] || 'üì¶';
    }

    function formatSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    // Logs
    function addLog(level, message) {
      const timestamp = new Date().toLocaleTimeString('fr-FR');
      logs.push({ timestamp, level, message });
      if (logs.length > 100) logs.shift();
      renderLogs();
    }

    function renderLogs() {
      const container = document.getElementById('logs-container');
      const colors = {
        'INFO': 'text-green-400',
        'WARN': 'text-yellow-400',
        'ERROR': 'text-red-400',
        'SUCCESS': 'text-cyan-400'
      };

      container.innerHTML = logs.map(log =>
        `<div class="${colors[log.level] || 'text-gray-400'}">[${escapeHtml(log.timestamp)}] ${escapeHtml(log.message)}</div>`
      ).join('');

      container.scrollTop = container.scrollHeight;
    }

    function clearLogs() {
      logs = [];
      renderLogs();
    }

    // ===== ABOUT MODAL =====
    function openAboutModal() {
      document.getElementById('about-modal').classList.remove('hidden');
    }

    function closeAboutModal() {
      document.getElementById('about-modal').classList.add('hidden');
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeAboutModal();
    });

    // ===== RUNNING JOBS INDICATOR =====
    async function checkRunningJobs() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/jobs?limit=50`);
        const data = await response.json();
        const runningJobs = data.jobs.filter(j => j.status === 'RUNNING');

        const indicator = document.getElementById('running-jobs-indicator');
        const countEl = document.getElementById('running-count');

        if (runningJobs.length > 0) {
          indicator.classList.remove('hidden');
          indicator.classList.add('flex');
          countEl.textContent = runningJobs.length;
          indicator.href = `dashboard_monitoring.html?job_id=${runningJobs[0].job_id}`;
        } else {
          indicator.classList.add('hidden');
          indicator.classList.remove('flex');
        }
      } catch (error) {
        console.error('Error checking running jobs:', error);
      }
    }

    // Init
    checkBackendConnection();
    loadDatabases();
    checkRunningJobs();
    setInterval(checkRunningJobs, 15000);
    // Reprendre le suivi des t√©l√©chargements en cours
    setTimeout(resumeActiveDownloads, 1000);
  </script>
</body>
</html>
